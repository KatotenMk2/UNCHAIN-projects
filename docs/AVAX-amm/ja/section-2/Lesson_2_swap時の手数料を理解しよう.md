### 🐣 swap 時の手数料について理解しましょう

前回のレッスンでは, swap 時にどのような計算によってプールで増減するトークンの量を求めるのかを考えました。

このレッスンではユーザの swap 時に手数料を設ける方法について考えます。

ポイントは以下です。

swap を要求するユーザがプールに送信するトークンの量を, AMM 内部では少しだけ少なく見積もった量に変換してから swap の計算をします。

今回は 0.3％ だけ少なく見積ります。

具体例で考えてみましょう。

🦴 状況

プールにはトークン X, Y がそれぞれ`10,000`ずつあるとします。

ユーザ A が X -> Y へ量　`1,000` を swap します。

前回のレッスンの `シチュエーション 1` で導き出した式

$$
y' = \frac{x'y}{x+x'}
$$

を使用すると,

- y': swap により得られる Y の量
- y : `10,000`
- x': `1,000`
- x : `10,000`

となります。

🐟 手数料を考慮しない場合

<!-- textlint-disable -->

$$
\begin{align}
y' &= \frac{1,000 * 10,000}{10,000 + 1,000}\\
&= 909.0...
\end{align}
$$

<!-- textlint-enable -->

プール内の X は 1,000 増えます。
Y は 909 減ります。

プール内のトークン X, Y の量はそれぞれ `11,000`, `9,091` となります。

🐿️ 手数料を考慮する場合

ユーザは X の量に `1,000` を指定して swap を実行しますが,
AMM の内部では `1,000` から 0.3％ の 3 を引いて `997` で計算をします。

$$
\begin{align}
y' &= \frac{997 * 10,000}{10,000 + 997}\\
&= 906.6...
\end{align}
$$

プール内の X は 1,000 増えます。
Y は 906 減ります。

プール内のトークン X, Y の量はそれぞれ `11,000`, `9,094` となります。

手数料を考慮しない場合に比べて,
ユーザが受け取れるトークン Y の量は減り
プールに残る Y の量は増えます。

Y -> X へ swap をするとこれと逆のことが起こります。

手数料を考慮しない場合に比べて,
ユーザが受け取れるトークン X の量は減り
プールに残る Y の量は増えます。

---

手数料を考慮して swap を繰り返すとプール内のトークン量は,
流動性の提供によって預けられたトークンの量に加え, swap 時にユーザから引いた手数料の量が上乗せされていきます。

すると流動性の提供者がプールから自分のシェアの分トークンを引き出す際, プール内のトークンの絶対量は提供時に比べて増えているので,
シェアに相当するトークンの量も増えます。

このようにして swap によって得られた手数料を流動性の提供者は得られるという仕組みになっています。

### 🐔 手数料を考慮した計算式を導きましょう

手数料の仕組みについて理解したので, 前回のレッスンで得られた計算式を手数料を考慮した計算式に変形します。

🦕 シチュエーション 1: x' から y' を算出する

元の式は以下です。

$$
y' = \frac{x'y}{x+x'}
$$

x'に関して, 0.3％ 引いた 0.997x' とすれば良いのですが,
後に solidity で実装する際に小数を扱えないことに備えて
全ての値に `1,000` をかけて 3 桁分繰り上げましょう。

<!-- textlint-disable -->

$$
1,000y' = \frac{997x' * 1,000y}{1,000x + 997x'}
$$

両辺を `1,000` で割ると以下の式が導き出せます。

$$
y' = \frac{997x'y}{1,000x + 997x'}
$$

<!-- textlint-enable -->

🐬 シチュエーション 2: y' から x' を算出する

元の式は以下です。

$$
x' = \frac{xy'}{y-y'}
$$

先ほどと同じように x' から 0.3％ 引き, 全ての値を 3 桁分繰り上げると以下のような形になります。

<!-- textlint-disable -->

$$
997x' = \frac{1,000x * 1,000y'}{1,000y - 1,000y'}
$$

<!-- textlint-enable -->

右辺は分母と分子をそれぞれ `1,000` で割ると

$$
997x' = \frac{1,000xy'}{y - y'}
$$

となり, 両辺を `997` で割ると

$$
x' = \frac{1,000xy'}{997(y - y')}
$$

x'について式が導き出せました。

ここで算出した計算式を AMM コントラクト内で実装していきます。

### 🙋‍♂️ 質問する

ここまでの作業で何かわからないことがある場合は,Discord の `#avax-amm` で質問をしてください。

ヘルプをするときのフローが円滑になるので,エラーレポートには下記の 3 点を記載してください ✨

```
1. 質問が関連しているセクション番号とレッスン番号
2. 何をしようとしていたか
3. エラー文をコピー&ペースト
4. エラー画面のスクリーンショット
```

次のレッスンでコントラクトに swap 機能を実装し, コントラクトを完成させましょう! 🎉
